<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление таблицами</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<nav>
    <a href="list.html">История сотрудников</a>
    <a href="index.html">Данные сотрудников</a>
    <a href="tables.html" class="active">Управление таблицами</a>
    <button id="authButton" class="auth-button"></button>
</nav>
<h1>Управление таблицами</h1>

<div class="tables-container">
    <div class="table-wrapper">
        
        <!-- Positions Table -->
        <table id="positionsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Название должности</th>
                    <th>Действия</th>
                </tr>
                <tr>
                    <td></td>
                    <td><input type="text" name="position_name" placeholder="Название должности" class="input-field" required></td>
                    <td><button id="addPositionButton">Добавить</button></td>
                </tr>
            </thead>
            <tbody> <!-- Данные должностей будут добавлены сюда с помощью JavaScript --> </tbody>
        </table>
    </div>

    <div class="table-wrapper">
        <!-- Professions Table -->
        <table id="professionsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Название профессии</th>
                    <th>Действия</th>
                </tr>
                <tr>
                    <td></td>
                    <td><input type="text" name="profession_name" placeholder="Название профессии" class="input-field" required></td>
                    <td><button id="addProfessionButton">Добавить</button></td>
                </tr>
            </thead>
            <tbody> <!-- Данные профессий будут добавлены сюда с помощью JavaScript --> </tbody>
        </table>
    </div>

 <div class="table-wrapper">
    <!-- Education Table -->
    <table id="educationTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Образование</th>
                <th>Действия</th>
            </tr>
            <tr>
                <td></td>
                <td><input type="text" name="education_name" placeholder="Введите образование" class="input-field" required></td>
                <td><button id="addEducationButton">Добавить</button></td>
            </tr>
        </thead>
        <tbody>
            <!-- Данные об образовании будут добавлены сюда с помощью JavaScript -->
        </tbody>
    </table>
</div>
</div>

<script>
    // Проверка роли пользователя
    const authButton = document.getElementById('authButton');
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username'); // Получаем имя пользователя

    if (token) {
        authButton.textContent = `Выйти (${username})`; // Отображаем имя пользователя
        authButton.onclick = () => {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            localStorage.removeItem('username'); // Удаляем имя пользователя
            window.location.href = 'login.html';
        };
    } else {
        authButton.textContent = 'Войти';
        authButton.onclick = () => {
            window.location.href = 'login.html';
        };
    }

    const positionsTableBody = document.getElementById('positionsTable').getElementsByTagName('tbody')[0];
    const addPositionButton = document.getElementById('addPositionButton');
    let editingPositionId = null;

    const professionsTableBody = document.getElementById('professionsTable').getElementsByTagName('tbody')[0];
    const addProfessionButton = document.getElementById('addProfessionButton');
    let editingProfessionId = null;

    const educationTableBody = document.getElementById('educationTable').getElementsByTagName('tbody')[0];
    const addEducationButton = document.getElementById('addEducationButton');
    let editingEducationId = null;
    // Функция для загрузки должностей
    async function loadPositions() {
        try {
            const response = await fetch('http://localhost:3000/api/positions');
            if (!response.ok) throw new Error('Ошибка при загрузке должностей');
            const data = await response.json();
            positionsTableBody.innerHTML = '';
            data.forEach(position => {
                const row = positionsTableBody.insertRow();
                row.setAttribute('data-id', position.id);
                row.innerHTML = `
                    <td>${position.id}</td>
                    <td>${position.name}</td>
                    <td>
                        <button onclick="editPosition(${position.id})">Изменить</button>
                        <button class="delete-button" onclick="deletePosition(${position.id})">Удалить</button>
                    </td>
                `;
            });
            applyRoleRestrictions(); // Применяем ограничения ролей
        } catch (error) {
            alert(error.message);
        }
    }

    // Функция для загрузки профессий
    async function loadProfessions() {
        try {
            const response = await fetch('http://localhost:3000/api/professions');
            if (!response.ok) throw new Error('Ошибка при загрузке профессий');
            const data = await response.json();
            professionsTableBody.innerHTML = '';
            data.forEach(profession => {
                const row = professionsTableBody.insertRow();
                row.setAttribute('data-id', profession.id);
                row.innerHTML = `
                    <td>${profession.id}</td>
                    <td>${profession.name}</td>
                    <td>
                        <button onclick="editProfession(${profession.id})">Изменить</button>
                        <button class="delete-button" onclick="deleteProfession(${profession.id})">Удалить</button>
                    </td>
                `;
            });
         applyRoleRestrictions(); // Применяем ограничения ролей
        } catch (error) {
            alert(error.message);
        }
    }
    async function loadEducation() {
        try {
            const response = await fetch('http://localhost:3000/api/education');
            if (!response.ok) throw new Error('Ошибка при загрузке образования');
            const data = await response.json();
            educationTableBody.innerHTML = '';
            data.forEach(education => {
                const row = educationTableBody.insertRow();
                row.setAttribute('data-id', education.id);
                row.innerHTML = `
                    <td>${education.id}</td>
                    <td>${education.name}</td>
                    <td>
                        <button onclick="editEducation(${education.id})">Изменить</button>
                        <button class="delete-button" onclick="deleteEducation(${education.id})">Удалить</button>
                    </td>
                `;
            });
          applyRoleRestrictions();
        } catch (error) {
            alert(error.message);
        }
    }
    // Функция для добавления или обновления должности
    async function savePosition() {
        const role = localStorage.getItem('role'); // Получаем роль пользователя

        // Проверяем, если роль editor и запись новая (editingPositionId отсутствует)
        if (role === 'editor' && !editingPositionId) {
            alert('У вас недостаточно прав для добавления новых записей.');
            return;
        }

        const name = document.querySelector('input[name="position_name"]').value;
        const positionData = { name };
        const method = editingPositionId ? 'PUT' : 'POST';
        const url = editingPositionId ? `http://localhost:3000/api/positions/${editingPositionId}` : 'http://localhost:3000/api/positions';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(positionData)
            });
            if (!response.ok) throw new Error('Ошибка при сохранении должности');
            clearPositionForm();
            loadPositions();
            editingPositionId = null;
        } catch (error) {
            alert(error.message);
        }
    }

    // Функция для добавления или обновления профессии
    async function saveProfession() {
        const role = localStorage.getItem('role'); // Получаем роль пользователя

        // Проверяем, если роль editor и запись новая (editingProfessionId отсутствует)
        if (role === 'editor' && !editingProfessionId) {
            alert('У вас недостаточно прав для добавления новых записей.');
            return;
        }

        const name = document.querySelector('input[name="profession_name"]').value;
        const professionData = { name };
        const method = editingProfessionId ? 'PUT' : 'POST';
        const url = editingProfessionId ? `http://localhost:3000/api/professions/${editingProfessionId}` : 'http://localhost:3000/api/professions';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(professionData)
            });
            if (!response.ok) throw new Error('Ошибка при сохранении профессии');
            clearProfessionForm();
            loadProfessions();
            editingProfessionId = null;
        } catch (error) {
            alert(error.message);
        }
    }
    // Функция для редактирования должности
    function editPosition(id) {
        const previouslyHighlightedRow = document.querySelector('.highlight');
    if (previouslyHighlightedRow) {
        previouslyHighlightedRow.classList.remove('highlight');
    }

    const row = document.querySelector(`tr[data-id='${id}']`);
    row.classList.add('highlight');
    const name = row.children[1].textContent;
    document.querySelector('input[name="position_name"]').value = name;
    editingPositionId = id;
    addPositionButton.textContent = "Сохранить"; // Меняем текст кнопки на "Сохранить"
}

    // Функция для редактирования профессии
    function editProfession(id) {
        const previouslyHighlightedRow = document.querySelector('.highlight');
    if (previouslyHighlightedRow) {
        previouslyHighlightedRow.classList.remove('highlight');
    }

    const row = document.querySelector(`tr[data-id='${id}']`);
    row.classList.add('highlight');
    const name = row.children[1].textContent;
    document.querySelector('input[name="profession_name"]').value = name;
    editingProfessionId = id;
    addProfessionButton.textContent = "Сохранить"; // Меняем текст кнопки на "Сохранить"
}
    // Функция для удаления должности
    async function deletePosition(id) {
        try {
            const response = await fetch(`http://localhost:3000/api/positions/${id}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Ошибка при удалении должности');
            loadPositions();
        } catch (error) {
            alert(error.message);
        }
    }

    // Функция для удаления профессии
    async function deleteProfession(id) {
        try {
            const response = await fetch(`http://localhost:3000/api/professions/${id}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Ошибка при удалении профессии');
            loadProfessions();
        } catch (error) {
            alert(error.message);
        }
    }

    async function saveEducation() {
        const role = localStorage.getItem('role'); // Получаем роль пользователя

        // Проверяем, если роль editor и запись новая (editingEducationId отсутствует)
        if (role === 'editor' && !editingEducationId) {
            alert('У вас недостаточно прав для добавления новых записей.');
            return;
        }

        const name = document.querySelector('input[name="education_name"]').value;
        const educationData = { name };
        const method = editingEducationId ? 'PUT' : 'POST';
        const url = editingEducationId ? `http://localhost:3000/api/education/${editingEducationId}` : 'http://localhost:3000/api/education';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(educationData)
            });
            if (!response.ok) throw new Error('Ошибка при сохранении образования');
            clearEducationForm();
            loadEducation();
            editingEducationId = null;
        } catch (error) {
            alert(error.message);
        }
    }

    function editEducation(id) {
        const previouslyHighlightedRow = document.querySelector('.highlight');
    if (previouslyHighlightedRow) {
        previouslyHighlightedRow.classList.remove('highlight');
    }

    const row = document.querySelector(`#educationTable tr[data-id='${id}']`);
    row.classList.add('highlight');
    const name = row.children[1].textContent;
    document.querySelector('input[name="education_name"]').value = name;
    editingEducationId = id;
    addEducationButton.textContent = "Сохранить"; // Меняем текст кнопки на "Сохранить"
}

    async function deleteEducation(id) {
        try {
            const response = await fetch(`http://localhost:3000/api/education/${id}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Ошибка при удалении образования');
            loadEducation();
        } catch (error) {
            alert(error.message);
        }
    }

    function clearEducationForm() {
        document.querySelector('input[name="education_name"]').value = '';
        addEducationButton.textContent = "Добавить"; // Сбрасываем текст кнопки
    }

    // Функция для очистки формы должности
    function clearPositionForm() {
        document.querySelector('input[name="position_name"]').value = '';
        addPositionButton.textContent = "Добавить"; // Сбрасываем текст кнопки
    }

    // Функция для очистки формы профессии
    function clearProfessionForm() {
        document.querySelector('input[name="profession_name"]').value = '';
        addProfessionButton.textContent = "Добавить"; // Сбрасываем текст кнопки
    }

    // Обработчик события для кнопки добавления должности
    addPositionButton.addEventListener('click', savePosition);

    // Обработчик события для кнопки добавления профессии
    addProfessionButton.addEventListener('click', saveProfession);

    addEducationButton.addEventListener('click', saveEducation);

    function applyRoleRestrictions() {
    const role = localStorage.getItem('role'); // Получаем роль пользователя

    if (role === 'user') {
        // Скрываем колонку "Действия" для всех таблиц
        const tables = ['positionsTable', 'professionsTable', 'educationTable'];
        tables.forEach(tableId => {
            const actionsColumnHeader = document.querySelector(`#${tableId} thead tr th:last-child`);
            actionsColumnHeader.style.display = 'none';

            const actionsColumnCells = document.querySelectorAll(`#${tableId} tbody tr td:last-child`);
            actionsColumnCells.forEach(cell => {
                cell.style.display = 'none';
            });

            const addRow = document.querySelector(`#${tableId} thead tr:nth-child(2)`);
            addRow.style.display = 'none';
        });
    } else if (role === 'editor') {
        // Скрываем кнопку "Удалить" для роли editor
        const deleteButtons = document.querySelectorAll('.delete-button');
        deleteButtons.forEach(button => {
            button.style.display = 'none';
        });
    }
}

// Вызов функции после загрузки данных
window.onload = function() {
    loadPositions();
    loadProfessions();
    loadEducation();
    applyRoleRestrictions();
};
</script>
</body>
</html>



