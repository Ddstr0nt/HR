<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>История штрафов и поощрений работников</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' fill='%232c3e50'/%3E%3Ctext x='50%25' y='55%25' font-size='28' fill='%23ffffff' font-family='Segoe%20UI' text-anchor='middle'%3EHR%3C/text%3E%3C/svg%3E"
    />
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-people-fill me-2"></i>Отдел кадров
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="home.html">
                <i class="bi bi-house-door me-1"></i>Главная
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="list.html">
                <i class="bi bi-clock-history me-1"></i>История сотрудников
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html">
                <i class="bi bi-person-lines-fill me-1"></i>Данные сотрудников
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="tables.html">
                <i class="bi bi-table me-1"></i>Управление таблицами
              </a>
            </li>
          </ul>
          <button id="authButton" class="btn btn-outline-light">
            <i class="bi bi-box-arrow-in-right me-1"></i>
            <span id="authButtonText">Войти</span>
          </button>
        </div>
      </div>
    </nav>

    <div class="container-fluid main-content">
      <div class="table-controls">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="h4 mb-0">
            <i class="bi bi-clock-history me-2"></i>История штрафов и поощрений
            работников
          </h1>
          <div class="d-flex">
            <button class="btn btn-update btn-sm me-2" onclick="loadList()">
              <i class="bi bi-arrow-clockwise me-1"></i>Обновить
            </button>
            <button
              id="cancelEditButton"
              class="btn btn-outline-danger btn-sm"
              style="display: none"
              onclick="cancelEdit()"
            >
              <i class="bi bi-x-lg me-1"></i>Отмена
            </button>
          </div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-responsive">
          <table
            class="table table-sm table-hover align-middle mb-0"
            id="listTable"
          >
            <thead>
              <tr>
                <th class="text-center">ID</th>
                <th>Работник</th>
                <th>Действия</th>
                <th>Сумма</th>
                <th>Дата</th>
                <th class="text-center">Действия</th>
              </tr>
              <tr class="sticky-add-row">
                <td class="text-center">
                  <i class="bi bi-plus-lg text-muted"></i>
                </td>
                <td>
                  <select
                    name="workers_id"
                    class="form-select form-select-sm"
                    required
                  >
                    <option value="">Выберите работника</option>
                  </select>
                </td>
                <td>
                  <select
                    name="actions_id"
                    class="form-select form-select-sm"
                    required
                  >
                    <option value="">Выберите действие</option>
                  </select>
                </td>
                <td>
                  <input
                    type="number"
                    name="sum"
                    placeholder="Сумма"
                    class="form-control form-control-sm"
                  />
                </td>
                <td>
                  <input
                    type="date"
                    name="date"
                    class="form-control form-control-sm"
                  />
                </td>
                <td class="text-center">
                  <button id="addListButton" class="btn btn-primary btn-sm">
                    <i class="bi"></i> Добавить
                  </button>
                </td>
              </tr>
            </thead>
            <tbody>
              <!-- Данные списка будут добавлены сюда с помощью JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div
          id="liveToast"
          class="toast"
          role="alert"
          aria-live="assertive"
          aria-atomic="true"
        >
          <div class="toast-header">
            <strong class="me-auto">Уведомление</strong>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="toast"
              aria-label="Close"
            ></button>
          </div>
          <div class="toast-body" id="toastMessage">
            <!-- Сообщение будет вставлено здесь -->
          </div>
        </div>
      </div>
      <!-- Confirm Modal -->
      <div
        class="modal fade"
        id="confirmModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Подтверждение</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body" id="confirmMessage">Вы уверены?</div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Отмена
              </button>
              <button type="button" class="btn btn-danger" id="confirmOkButton">
                Удалить
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Инициализация Toast
      const toastLiveExample = document.getElementById("liveToast");
      const toast = new bootstrap.Toast(toastLiveExample);

      function showToast(message, isSuccess = true) {
        const toastBody = document.getElementById("toastMessage");
        toastBody.textContent = message;
        toastBody.className =
          "toast-body" + (isSuccess ? " text-success" : " text-danger");
        toast.show();
      }

      // Модальное подтверждение вместо confirm()
      function showConfirm(message) {
        return new Promise((resolve) => {
          const modalEl = document.getElementById("confirmModal");
          const messageEl = document.getElementById("confirmMessage");
          const okBtn = document.getElementById("confirmOkButton");
          messageEl.textContent = message || "Подтвердите действие";
          const modal = new bootstrap.Modal(modalEl);

          const cleanup = () => {
            okBtn.removeEventListener("click", onOk);
            modalEl.removeEventListener("hidden.bs.modal", onHide);
          };
          const onOk = () => {
            cleanup();
            modal.hide();
            resolve(true);
          };
          const onHide = () => {
            cleanup();
            resolve(false);
          };

          okBtn.addEventListener("click", onOk, { once: true });
          modalEl.addEventListener("hidden.bs.modal", onHide, { once: true });
          modal.show();
        });
      }

      // Loading helpers (spinner + skeleton rows)
      function setLoading(isLoading) {
        const updateBtn = document.querySelector(".btn-update");
        if (!updateBtn) return;
        if (isLoading) {
          updateBtn.disabled = true;
          updateBtn.dataset.originalInner = updateBtn.innerHTML;
          updateBtn.innerHTML =
            '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Загрузка';
        } else {
          if (updateBtn.dataset.originalInner) {
            updateBtn.innerHTML = updateBtn.dataset.originalInner;
            delete updateBtn.dataset.originalInner;
          }
          updateBtn.disabled = false;
        }
      }

      function renderSkeletonRows() {
        listTableBody.innerHTML = "";
        const rows = 8;
        const cols = 6;
        for (let r = 0; r < rows; r++) {
          const tr = listTableBody.insertRow();
          tr.className = "skeleton-row";
          for (let c = 0; c < cols; c++) {
            const td = tr.insertCell();
            td.innerHTML = '<div class="skeleton" style="height: 12px;"></div>';
          }
        }
      }

      const authButton = document.getElementById("authButton");
      const authButtonText = document.getElementById("authButtonText");
      const token = localStorage.getItem("token");
      const username = localStorage.getItem("username");

      if (token) {
        authButtonText.textContent = `Выйти (${username})`;
        authButton.onclick = () => {
          localStorage.removeItem("token");
          localStorage.removeItem("role");
          localStorage.removeItem("username");
          window.location.href = "login.html";
        };
      } else {
        authButtonText.textContent = "Войти";
        authButton.onclick = () => {
          window.location.href = "login.html";
        };
      }

      const role = localStorage.getItem("role");
      if (!role) {
        window.location.href = "login.html";
      }

      const listTableBody = document
        .getElementById("listTable")
        .getElementsByTagName("tbody")[0];
      const addListButton = document.getElementById("addListButton");
      let editingListId = null;

      let workersData = [];
      let actionsData = [];

      // Функция для загрузки работников в выпадающий список
      function loadWorkers() {
        fetch("http://localhost:3000/workers")
          .then((response) => {
            if (!response.ok) throw new Error("Ошибка загрузки работников");
            return response.json();
          })
          .then((data) => {
            workersData = data;
            const workersSelect = document.querySelector(
              'select[name="workers_id"]'
            );
            workersSelect.innerHTML =
              '<option value="">Выберите работника</option>';
            data.forEach((worker) => {
              const option = document.createElement("option");
              option.value = worker.id;
              option.textContent = `${worker.fam} ${worker.name} ${worker.otch}`;
              workersSelect.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Ошибка:", error);
            showToast("Ошибка загрузки списка работников", false);
          });
      }

      function loadActions() {
        fetch("http://localhost:3000/api/actions")
          .then((response) => {
            if (!response.ok) throw new Error("Ошибка загрузки действий");
            return response.json();
          })
          .then((data) => {
            actionsData = data;
            const actionsSelect = document.querySelector(
              'select[name="actions_id"]'
            );
            actionsSelect.innerHTML =
              '<option value="">Выберите действие</option>';
            data.forEach((action) => {
              const option = document.createElement("option");
              option.value = action.id;
              option.textContent = `${action.name}`;
              actionsSelect.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Ошибка:", error);
            showToast("Ошибка загрузки списка действий", false);
          });
      }

      // Функция для загрузки элементов списка
      function loadList() {
        setLoading(true);
        renderSkeletonRows();
        fetch("http://localhost:3000/list")
          .then((response) => response.json())
          .then((data) => {
            listTableBody.innerHTML = "";
            if (data.length === 0) {
              const row = listTableBody.insertRow();
              row.innerHTML = `<td colspan="6" class="text-center text-muted py-3">Нет данных о штрафах и поощрениях</td>`;
              return;
            }

            data.forEach((item) => {
              const row = listTableBody.insertRow();
              row.setAttribute("data-id", item.id);
              row.setAttribute("data-worker-id", item.workers_id);
              row.setAttribute("data-action-id", item.actions_id);

              const action = actionsData.find((a) => a.id === item.actions_id);
              const actionName = action ? action.name : "Не указано";

              const worker = workersData.find((w) => w.id === item.workers_id);
              const workerName = worker
                ? `${worker.fam} ${worker.name} ${worker.otch}`
                : "Не указано";

              const sumDisplay = item.sum ? `${item.sum} руб.` : "0 руб.";
              const dateDisplay = item.date
                ? new Date(item.date).toLocaleDateString("ru-RU")
                : "Не указана";

              row.innerHTML = `
                <td class="text-center">${item.id}</td>
                <td>${workerName}</td>
                <td>${actionName}</td>
                <td>${sumDisplay}</td>
                <td>${dateDisplay}</td>
                <td class="action-buttons text-center">
                  <button onclick="editListItem(${item.id})" class="btn btn-warning btn-sm">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-danger btn-sm delete-button" onclick="deleteListItem(${item.id})">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              `;
            });
            applyRoleRestrictions();
          })
          .catch((error) => {
            console.error("Ошибка:", error);
            showToast("Ошибка загрузки истории", false);
          })
          .finally(() => {
            setLoading(false);
          });
      }

      // Функция для добавления или обновления элемента списка
      function saveListItem() {
        const role = localStorage.getItem("role");
        if (role === "editor" && !editingListId) {
          showToast(
            "У вас недостаточно прав для добавления новых записей.",
            false
          );
          return;
        }

        const workers_id = document.querySelector(
          'select[name="workers_id"]'
        ).value;
        const actions_id = document.querySelector(
          'select[name="actions_id"]'
        ).value;
        const sum = document.querySelector('input[name="sum"]').value || null;
        const date = document.querySelector('input[name="date"]').value || null;

        if (!workers_id || !actions_id) {
          showToast("Выберите работника и действие", false);
          return;
        }

        const listData = {
          workers_id,
          actions_id,
          sum,
          date,
        };

        const method = editingListId ? "PUT" : "POST";
        const url = editingListId
          ? `http://localhost:3000/list/${editingListId}`
          : "http://localhost:3000/list";

        fetch(url, {
          method: method,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(listData),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Ошибка при добавлении/обновлении элемента");
            }
            return response.json();
          })
          .then(() => {
            clearForm();
            loadList();
            editingListId = null;
            addListButton.innerHTML = '<i class="bi"></i> Добавить';
            document.getElementById("cancelEditButton").style.display = "none";
            showToast(
              editingListId ? "Запись обновлена" : "Запись добавлена",
              true
            );
          })
          .catch((error) => {
            console.error("Ошибка:", error);
            showToast(error.message, false);
          });
      }

      // Функция для очистки формы
      function clearForm() {
        document.querySelector('select[name="workers_id"]').value = "";
        document.querySelector('select[name="actions_id"]').value = "";
        document.querySelector('input[name="sum"]').value = "";
        document.querySelector('input[name="date"]').value = "";
        addListButton.innerHTML = '<i class="bi"></i> Добавить';
      }

      // Функция для удаления элемента списка
      async function deleteListItem(id) {
        const confirmed = await showConfirm(
          "Вы уверены, что хотите удалить эту запись?"
        );
        if (!confirmed) return;
        fetch(`http://localhost:3000/list/${id}`, {
          method: "DELETE",
        })
          .then(() => {
            loadList();
            showToast("Запись удалена", true);
          })
          .catch((error) => {
            console.error("Ошибка:", error);
            showToast("Ошибка при удалении записи", false);
          });
      }

      // Функция для редактирования элемента списка
      function editListItem(id) {
        const previouslyHighlightedRow = document.querySelector(".highlight");
        if (previouslyHighlightedRow)
          previouslyHighlightedRow.classList.remove("highlight");

        const row = listTableBody.querySelector(`tr[data-id="${id}"]`);
        row.classList.add("highlight");

        const workerId = row.getAttribute("data-worker-id");
        const actionId = row.getAttribute("data-action-id");
        const sum = row.cells[3].innerText.replace(" руб.", "");
        const dateText = row.cells[4].innerText;
        let dateValue = "";
        if (dateText !== "Не указана") {
          const [day, month, year] = dateText.split(".");
          dateValue = `${year}-${month.padStart(2, "0")}-${day.padStart(
            2,
            "0"
          )}`;
        }

        document.querySelector('select[name="workers_id"]').value = workerId;
        document.querySelector('select[name="actions_id"]').value = actionId;
        document.querySelector('input[name="sum"]').value = sum;
        document.querySelector('input[name="date"]').value = dateValue;

        editingListId = id;
        document.getElementById("addListButton").innerHTML =
          '<i class="bi"></i> Сохранить';
        document.getElementById("cancelEditButton").style.display =
          "inline-block";
      }

      function cancelEdit() {
        clearForm();
        editingListId = null;
        document.getElementById("cancelEditButton").style.display = "none";
        document.getElementById("addListButton").innerHTML =
          '<i class="bi"></i> Добавить';

        // Удаляем выделение строки
        const highlightedRow = document.querySelector(".highlight");
        if (highlightedRow) highlightedRow.classList.remove("highlight");
      }

      // Функция для очистки формы
      function clearForm() {
        document.querySelector('select[name="workers_id"]').value = "";
        document.querySelector('select[name="actions_id"]').value = "";
        document.querySelector('input[name="sum"]').value = "";
        document.querySelector('input[name="date"]').value = "";
      }

      function applyRoleRestrictions() {
        const role = localStorage.getItem("role");
        if (!role) return;

        if (role === "user") {
          document
            .querySelectorAll(
              "#listTable th:last-child, #listTable td:last-child"
            )
            .forEach((el) => {
              el.style.display = "none";
            });
          document.querySelector(
            "#listTable thead tr:nth-child(2)"
          ).style.display = "none";
        } else if (role === "editor") {
          document.querySelectorAll(".delete-button").forEach((button) => {
            button.style.display = "none";
          });
        }
      }

      // Инициализация при загрузке страницы
      document.addEventListener("DOMContentLoaded", () => {
        loadWorkers();
        loadActions();
        loadList();
        applyRoleRestrictions();

        addListButton.addEventListener("click", function (event) {
          event.preventDefault();
          saveListItem();
        });

        document.addEventListener("keydown", function (event) {
          if (event.code === "Enter") {
            event.preventDefault();
            saveListItem();
          }
        });
      });
    </script>

    <footer class="py-3 mt-4 footer-dark">
      <div class="container">
        <ul
          class="nav justify-content-center border-bottom border-light pb-3 mb-3"
          style="max-width: 2000px; margin: 0 auto"
        >
          <li class="nav-item">
            <a href="home.html" class="nav-link px-2 text-light">Главная</a>
          </li>
          <li class="nav-item">
            <a href="list.html" class="nav-link px-2 text-light"
              >История сотрудников</a
            >
          </li>
          <li class="nav-item">
            <a href="index.html" class="nav-link px-2 text-light"
              >Данные сотрудников</a
            >
          </li>
          <li class="nav-item">
            <a href="tables.html" class="nav-link px-2 text-light"
              >Управление таблицами</a
            >
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link px-2 text-light">О нас</a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link px-2 text-light">FAQ</a>
          </li>
        </ul>
        <p class="text-center text-light mb-0">
          &copy; 2025 Отдел кадров. Все права защищены.
        </p>
        <p class="text-center text-light mb-0">
          Контакты:
          <a href="mailto:support@hr-system.com" class="text-light"
            >support@hr-system.com</a
          >
        </p>
        <p class="text-center text-light mb-0">Телефон: +7 (495) 123-45-67</p>
      </div>
    </footer>
  </body>
</html>
